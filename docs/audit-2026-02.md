# Audit Chiron — Février 2026

## 1. Documentation

### README.md

| # | Constat | Sévérité | Corrigé |
|---|---------|----------|---------|
| 1 | Diagramme pipeline : mentionne `pdfplumber` comme parser principal, devrait être `yaml_template` | MOYENNE | Oui |
| 2 | Structure du projet incomplète : manque `yaml_template_parser.py`, `validation.py`, `debug_visualizer.py`, `templates/`, `pricing.py`, `rate_limiter.py`, `base.py` | MOYENNE | Oui |
| 3 | Stack technique dit "PDF: pdfplumber" — devrait mentionner yaml_template comme méthode principale | BASSE | Oui |
| 4 | Formulation RGPD "données nominatives jamais envoyées" — préciser que seuls noms/prénoms sont pseudonymisés, les notes/absences/appréciations pseudonymisées sont transmises | MOYENNE | Oui |

### docs/architecture.md

| # | Constat | Sévérité | Corrigé |
|---|---------|----------|---------|
| 1 | Flux d'import : étape 1 dit "pdfplumber" mais c'est `anonymizer.py` (regex) | HAUTE | Oui |
| 2 | Table composants incomplète : manque `validation.py`, `debug_visualizer.py`, `rate_limiter.py` | MOYENNE | Oui |
| 3 | Pas de mention du composite PK `(eleve_id, classe_id, trimestre)` | MOYENNE | Oui |

### docs/adapter-format-bulletin.md

| # | Constat | Sévérité | Corrigé |
|---|---------|----------|---------|
| 1 | Référence exclusivement `pdfplumber_parser.py` — ne mentionne pas le yaml_template_parser | HAUTE | Oui |
| 2 | Résumé final ne mentionne pas les templates YAML | HAUTE | Oui |

### app/pages/home.py (UI)

| # | Constat | Sévérité | Corrigé |
|---|---------|----------|---------|
| 1 | Tableau RGPD dit "Genre — Transmis à l'IA" mais `format_eleve_data()` ne transmet PAS le genre. Le prompt dit "Déduis le genre à partir des accords grammaticaux". C'est le home page qui est faux. | HAUTE | A faire |

---

## 2. DRY — Violations identifiées

### Cause racine
L'architecture à double chemin (API HTTP vs appels directs DB dans `cache.py`) crée une duplication systématique. `cache.py` commente explicitement "Reproduit la logique de POST /syntheses/generate".

### Violations

| # | Duplication | Fichiers | Sévérité |
|---|------------|----------|----------|
| 1 | Metadata dict LLM (11 clés) copié 4 fois | `cache.py` ×2, `syntheses.py` ×2 | **HAUTE** |
| 2 | Pipeline post-génération (depseudo + delete + hash + create) | `cache.py`, `syntheses.py` | **HAUTE** |
| 3 | `fetch_eleves_with_syntheses` vs endpoint `/classes/{id}/eleves-with-syntheses` | `cache.py`, `classes.py` | **HAUTE** |
| 4 | Stats classe, synthèse élève — dicts réponse identiques | `cache.py`, `classes.py`, `eleves.py` | MOYENNE |
| 5 | Temp-file write/unlink try/finally — 5 occurrences | `cache.py` ×2, `exports.py` ×3 | MOYENNE |
| 6 | "Get or create Classe" — 3 occurrences | `cache.py`, `exports.py` ×2 | MOYENNE |
| 7 | Validators `trimestre` et `provider` copiés dans le même fichier | `syntheses.py` | MOYENNE |
| 8 | Word-boundary regex name replacement | `cache.py`, `exports.py` | MOYENNE |
| 9 | `parse()` boilerplate (path check, load, empty guard) | `pdfplumber_parser.py`, `yaml_template_parser.py` | BASSE |

### Solution recommandée
Extraire une **couche service** (`src/services/`) entre les routers et `cache.py` pour centraliser la logique métier.

---

## 3. KISS — Points d'attention

| Observation | Verdict |
|---|---|
| Architecture monolithe NiceGUI + FastAPI | OK (adapté au use case desktop) |
| LLMManager registry/retry/rate-limiting | OK (complexité justifiée) |
| Two-DB architecture RGPD | OK (séparation légitime) |
| `cache.py` ~700 lignes mélange cache + logique métier + orchestration | **A splitter** |

---

## 4. YAGNI — Code inutilisé ou prématuré

| # | Élément | Statut |
|---|---------|--------|
| 1 | Colonnes OCR dans `eleves` (`ocr_provider`, `ocr_model`, `ocr_cost`, `ocr_duration_ms`) | Jamais peuplées |
| 2 | `app/main.py` — fichier vide/stub | A supprimer |
| 3 | `src/api/main.py` — app FastAPI standalone | Potentiellement inutile (seul le mode NiceGUI-mounted est utilisé) |
| 4 | `pdfplumber_parser.py` — parser legacy complet | A évaluer si encore nécessaire |

---

## 5. Tests et CI/CD

| Dimension | Statut |
|---|---|
| Fichiers de test | 1 seul `__init__.py` vide — **aucun test** |
| Couverture | **0%** |
| pytest | Installé, non configuré |
| pytest-cov | Non installé |
| CI/CD | Aucun (pas de GitHub Actions) |
| Pre-commit | Présent (ruff format/lint uniquement) |

### Priorités de tests
1. `src/document/parser.py` — pure functions, facile à tester
2. `src/privacy/pseudonymizer.py` — RGPD, critique
3. `src/document/validation.py` — feature récente
4. `src/llm/rate_limiter.py` — logique async, `reset()` déjà prévu pour tests

---

## 6. Open-source readiness

### Bloquants

| # | Bloquant | Priorité |
|---|----------|----------|
| 1 | 0 tests | **CRITIQUE** |
| 2 | 0 CI/CD | **CRITIQUE** |
| 3 | Licence propriétaire | **CRITIQUE** |
| 4 | Documentation périmée | HAUTE |
| 5 | Pas de CONTRIBUTING.md | HAUTE |
| 6 | Pas de CHANGELOG | MOYENNE |
| 7 | Violations DRY (maintenance difficile pour contributeurs) | HAUTE |

### Points positifs
- Code Python propre, bien typé (Pydantic v2)
- Séparation des responsabilités claire
- `.pre-commit-config.yaml` avec ruff
- `pyproject.toml` moderne avec `uv`
- `.env.example` existe
- Pas de credentials hardcodées
- Logging cohérent (pas de print sauvage)

---

## 7. Bugs identifiés

| # | Bug | Fichier | Sévérité |
|---|-----|---------|----------|
| 1 | Home page dit "Genre transmis à l'IA" mais c'est faux (`format_eleve_data()` ne le transmet pas) | `app/pages/home.py:220` | HAUTE |
| 2 | Batch generation via API (`POST /syntheses/generate-batch`) ne charge pas les few-shot examples (contrairement au path UI) | `src/api/routers/syntheses.py` | MOYENNE |
