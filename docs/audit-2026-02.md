# Audit Chiron — Février 2026

## Corrections effectuées

| Date | Scope | Description |
|------|-------|-------------|
| 2026-02-18 | Documentation | Corrigé README.md, architecture.md, adapter-format-bulletin.md |
| 2026-02-18 | DRY | Extraction couche service (`src/services/`), refactoring cache.py (666→290 lignes) et routers |
| 2026-02-18 | Bug fix | Corrigé "Genre transmis à l'IA" → "non transmis" dans home.py |
| 2026-02-18 | YAGNI | Supprimé colonnes OCR inutilisées, `src/api/main.py` et `src/api/config.py` standalone |
| 2026-02-19 | Bug fix | Activé few-shot examples dans les endpoints API (`use_fewshot=True`) |
| 2026-02-19 | RGPD | Cascade suppression `privacy.duckdb` : supprimer un élève nettoie son mapping |
| 2026-02-19 | RGPD | Bouton purge trimestrielle sur la page Export (suppression données après export) |
| 2026-02-19 | RGPD | Documentation base légale (Art. 6(1)(e)) dans l'UI page d'accueil |
| 2026-02-19 | RGPD | Suppression colonne `raw_text` de la DB (minimisation des données) |
| 2026-02-19 | Bug fix | Corrigé `clear_mappings()` : `RETURNING` au lieu de `rowcount` (bug DuckDB) |
| 2026-02-19 | Tests | 42 tests unitaires : pseudonymisation, regex extraction, purge trimestrielle |
| 2026-02-19 | Documentation | Mise à jour README, architecture.md, plan-rgpd-remediation.md |

---

## Audit RGPD — Privacy by design

### Points forts

| Critère | Mesure en place |
|---------|-----------------|
| Pseudonymisation (Art. 25) | Double filet : regex + NER CamemBERT local |
| Minimisation (Art. 5(1)(c)) | Notes catégorisées (LSU), `raw_text` non persisté, genre/absences/retards non transmis |
| Séparation des bases | `privacy.duckdb` (mappings sensibles) séparée de `chiron.duckdb` (données pseudonymisées) |
| Traitement local | PDF parsing, NER, DB — tout est local. Seul le LLM est cloud |
| Validation humaine | Workflow obligatoire avant export |
| Scope dépseudonymisation | Filtré par `classe_id` pour éviter les fuites inter-classes |

### Corrections apportées (2026-02-19)

| Problème | Correction | Fichiers |
|----------|------------|----------|
| Suppression élève ne nettoyait pas `privacy.duckdb` | Cascade via `eleve_repo.exists()` + `clear_mapping_for_eleve()` | `cache.py`, `pseudonymizer.py` |
| Pas de purge des données après export | Bouton "Purge trimestrielle" sur `/export` | `cache.py`, `export.py` |
| `raw_text` stocké inutilement | Colonne retirée + migration `DROP COLUMN` | `schemas.py`, `eleve.py`, `exports.py` |
| Pas de base légale documentée | Section dans l'expansion privacy de `/home` | `home.py` |
| `clear_mappings()` retournait -1 | Utilise `RETURNING 1` + `len(rows)` | `pseudonymizer.py` |
| 0% de couverture tests privacy | 42 tests unitaires | `tests/` (3 fichiers) |

### Reste à évaluer (hors scope actuel)

| Sujet | Note |
|-------|------|
| DPA fournisseurs LLM | Vérifier les politiques de rétention d'OpenAI, Anthropic, Mistral. Activer zero-retention si disponible |
| Registre de traitement formel | Pas de registre CNIL au sens strict — le tableau dans l'UI est informatif, pas réglementaire |
| AIPD | Une analyse d'impact (AIPD) pourrait être requise si l'outil est déployé à l'échelle d'un établissement |

---

## Reste à faire

### 1. Tests

**Couverture actuelle : 42 tests (pseudonymisation, extraction, purge)**

#### Priorité 1 — Tests unitaires (fonctions pures)

Aucune dépendance externe, exécution instantanée.

| Fichier | Quoi tester |
|---------|-------------|
| `src/services/shared.py` | `build_llm_metadata()` retourne les 11 clés attendues |
| `src/document/validation.py` | `validate_extraction()` détecte les bulletins invalides (pas de matières, notes hors bornes...) |
| `src/document/anonymizer.py` | `extract_eleve_name()` extrait nom/prénom depuis un texte brut |
| `src/core/models.py` | Validation Pydantic (notes > 20, trimestres invalides...) |

#### ~~Priorité 2 — Pseudonymisation (RGPD critique)~~ FAIT

42 tests dans `tests/test_pseudonymizer.py` (16), `tests/test_pseudonymize_extraction.py` (16), `tests/test_purge.py` (6).

Cas couverts : création idempotente, casse/accents/noms composés, dépseudonymisation scopée, cascade suppression, purge trimestrielle, word boundary, occurrences multiples.

#### Priorité 3 — Repositories (CRUD base de données)

Base DuckDB `:memory:` avec schéma initialisé.

| Repository | Quoi tester |
|------------|-------------|
| `ClasseRepository` | Créer, lire, lister, supprimer |
| `EleveRepository` | Créer, `exists()`, clé composite `(eleve_id, classe_id, trimestre)` |
| `SyntheseRepository` | Créer, update status, `get_validated()`, `get_pending()` |

#### Priorité 4 — Endpoints API (FastAPI TestClient)

Requêtes HTTP simulées sans serveur.

| Router | Quoi tester |
|--------|-------------|
| `exports.py` | Upload PDF invalide → 400, fichier trop gros → 400 |
| `syntheses.py` | Trimestre = 5 → erreur validation, provider inconnu → erreur |
| `classes.py` | GET classe inexistante → 404 |

#### Priorité 5 — Intégration (pipeline complet)

Flux import PDF → parsing → pseudonymisation → stockage, avec un PDF de test anonymisé.

#### Non testé (volontairement)

- **Sorties LLM** : non déterministes → on mocke le LLM et on teste le pipeline autour
- **UI NiceGUI** : complexe, faible valeur ajoutée pour un outil desktop
- **Tests E2E navigateur** : disproportionné pour le use case

### 2. CI/CD

| Élément | Statut |
|---------|--------|
| GitHub Actions | `.github/workflows/ci.yml` — lint (ruff) + tests (pytest --cov) sur push/PR main |
| pytest-cov | Ajouté aux dev dependencies |
| Pre-commit | Présent (ruff format/lint uniquement) |

### 3. Open-source readiness

| Élément | Priorité | Statut |
|---------|----------|--------|
| Tests | CRITIQUE | En cours (42/~100) |
| CI/CD | CRITIQUE | Fait (`ci.yml`) |
| Licence | CRITIQUE | Fait (Apache 2.0) |

### ~~4. DRY résiduel~~ FAIT

Suppression de `PdfplumberParser` (legacy) — un seul parser (`YamlTemplateParser`).
