# Audit Chiron — Février 2026

## 1. Documentation

### README.md

| # | Constat | Sévérité | Corrigé |
|---|---------|----------|---------|
| 1 | Diagramme pipeline : mentionne `pdfplumber` comme parser principal, devrait être `yaml_template` | MOYENNE | Oui |
| 2 | Structure du projet incomplète : manque `yaml_template_parser.py`, `validation.py`, `debug_visualizer.py`, `templates/`, `pricing.py`, `rate_limiter.py`, `base.py` | MOYENNE | Oui |
| 3 | Stack technique dit "PDF: pdfplumber" — devrait mentionner yaml_template comme méthode principale | BASSE | Oui |
| 4 | Formulation RGPD "données nominatives jamais envoyées" — préciser que seuls noms/prénoms sont pseudonymisés, les notes/absences/appréciations pseudonymisées sont transmises | MOYENNE | Oui |

### docs/architecture.md

| # | Constat | Sévérité | Corrigé |
|---|---------|----------|---------|
| 1 | Flux d'import : étape 1 dit "pdfplumber" mais c'est `anonymizer.py` (regex) | HAUTE | Oui |
| 2 | Table composants incomplète : manque `validation.py`, `debug_visualizer.py`, `rate_limiter.py` | MOYENNE | Oui |
| 3 | Pas de mention du composite PK `(eleve_id, classe_id, trimestre)` | MOYENNE | Oui |

### docs/adapter-format-bulletin.md

| # | Constat | Sévérité | Corrigé |
|---|---------|----------|---------|
| 1 | Référence exclusivement `pdfplumber_parser.py` — ne mentionne pas le yaml_template_parser | HAUTE | Oui |
| 2 | Résumé final ne mentionne pas les templates YAML | HAUTE | Oui |

### app/pages/home.py (UI)

| # | Constat | Sévérité | Corrigé |
|---|---------|----------|---------|
| 1 | Tableau RGPD dit "Genre — Transmis à l'IA" mais `format_eleve_data()` ne transmet PAS le genre. Le prompt dit "Déduis le genre à partir des accords grammaticaux". C'est le home page qui est faux. | HAUTE | Oui |

---

## 2. DRY — Violations identifiées et corrigées

### Refactoring effectué

Extraction d'une **couche service** (`src/services/`) pour éliminer la duplication entre `cache.py` (chemin UI direct) et les routers API :

```
Avant :  Pages UI → cache.py (logique copiée)     Clients API → routers/ (même logique copiée)
Après :  Pages UI → cache.py → services/           Clients API → routers/ → services/
                                    ↓
                              repositories/
```

#### Fichiers créés

| Fichier | Rôle |
|---------|------|
| `src/services/__init__.py` | Package de la couche service |
| `src/services/shared.py` | `build_llm_metadata()`, `temp_pdf_file()`, `ensure_classe_exists()`, `VALID_PROVIDERS`, `VALID_TRIMESTRES` |
| `src/services/synthese_service.py` | `generate_single()`, `generate_batch()`, `persist_synthese()`, `get_fewshot_generator()` |
| `src/services/query_service.py` | `get_classe_stats()`, `get_eleves_with_syntheses()`, `get_eleve_synthese()` |

#### Violations corrigées

| # | Duplication | Corrigé par | Statut |
|---|------------|-------------|--------|
| 1 | Metadata dict LLM (11 clés) copié 4× | `shared.build_llm_metadata()` | **Corrigé** |
| 2 | Pipeline post-génération (depseudo + delete + hash + create) | `synthese_service.persist_synthese()` | **Corrigé** |
| 3 | `fetch_eleves_with_syntheses` vs endpoint | `query_service.get_eleves_with_syntheses()` | **Corrigé** |
| 4 | Stats classe et synthèse élève — dicts identiques | `query_service.get_classe_stats()` / `get_eleve_synthese()` | **Corrigé** |
| 5 | Temp-file write/unlink try/finally — 5× | `shared.temp_pdf_file()` context manager | **Corrigé** |
| 6 | "Get or create Classe" — 3× | `shared.ensure_classe_exists()` | **Corrigé** |
| 7 | Validators `trimestre` et `provider` copiés | `shared.VALID_PROVIDERS/VALID_TRIMESTRES` + fonctions partagées | **Corrigé** |
| 8 | Word-boundary regex name replacement | `synthese_service._re_pseudonymize_text()` | **Corrigé** |
| 9 | `parse()` boilerplate entre les deux parsers | Non traité (basse priorité) | Reste |

### Résultat

- `cache.py` : **666 → 290 lignes** (pure couche cache + délégation aux services)
- `syntheses.py` : **440 → 240 lignes** (pure couche HTTP + délégation aux services)
- Logique métier centralisée dans `src/services/` (~380 lignes)
- Zéro duplication de logique métier entre UI et API

---

## 3. KISS — Points d'attention

| Observation | Verdict |
|---|---|
| Architecture monolithe NiceGUI + FastAPI | OK (adapté au use case desktop) |
| LLMManager registry/retry/rate-limiting | OK (complexité justifiée) |
| Two-DB architecture RGPD | OK (séparation légitime) |
| `cache.py` ~700 lignes mélange cache + logique métier + orchestration | **Corrigé** (290 lignes) |

---

## 4. YAGNI — Code inutilisé ou prématuré

| # | Élément | Statut |
|---|---------|--------|
| 1 | Colonnes OCR dans `eleves` (`ocr_provider`, `ocr_model`, `ocr_cost`, `ocr_duration_ms`) | Jamais peuplées |
| 2 | `app/main.py` — fichier vide/stub | A supprimer |
| 3 | `src/api/main.py` — app FastAPI standalone | Potentiellement inutile (seul le mode NiceGUI-mounted est utilisé) |
| 4 | `pdfplumber_parser.py` — parser legacy complet | A évaluer si encore nécessaire |

---

## 5. Tests et CI/CD

| Dimension | Statut |
|---|---|
| Fichiers de test | 1 seul `__init__.py` vide — **aucun test** |
| Couverture | **0%** |
| pytest | Installé, non configuré |
| pytest-cov | Non installé |
| CI/CD | Aucun (pas de GitHub Actions) |
| Pre-commit | Présent (ruff format/lint uniquement) |

### Priorités de tests
1. `src/services/shared.py` — pure functions, facile à tester
2. `src/document/parser.py` — pure functions, facile à tester
3. `src/privacy/pseudonymizer.py` — RGPD, critique
4. `src/document/validation.py` — feature récente
5. `src/llm/rate_limiter.py` — logique async, `reset()` déjà prévu pour tests
6. `src/services/synthese_service.py` — cœur de la logique métier (avec mocks LLM)

---

## 6. Open-source readiness

### Bloquants

| # | Bloquant | Priorité |
|---|----------|----------|
| 1 | 0 tests | **CRITIQUE** |
| 2 | 0 CI/CD | **CRITIQUE** |
| 3 | Licence propriétaire | **CRITIQUE** |
| 4 | Documentation périmée | ~~HAUTE~~ **Corrigé** |
| 5 | Pas de CONTRIBUTING.md | HAUTE |
| 6 | Pas de CHANGELOG | MOYENNE |
| 7 | Violations DRY (maintenance difficile pour contributeurs) | ~~HAUTE~~ **Corrigé** |

### Points positifs
- Code Python propre, bien typé (Pydantic v2)
- Séparation des responsabilités claire
- **Couche service extraite** (DRY)
- `.pre-commit-config.yaml` avec ruff
- `pyproject.toml` moderne avec `uv`
- `.env.example` existe
- Pas de credentials hardcodées
- Logging cohérent (pas de print sauvage)

---

## 7. Bugs identifiés

| # | Bug | Fichier | Sévérité | Corrigé |
|---|-----|---------|----------|---------|
| 1 | Home page dit "Genre transmis à l'IA" mais c'est faux (`format_eleve_data()` ne le transmet pas) | `app/pages/home.py:220` | HAUTE | Oui |
| 2 | Batch generation via API ne chargeait pas les few-shot (contrairement au path UI) | `src/api/routers/syntheses.py` | MOYENNE | Cohérence rétablie via `synthese_service` (le router passe `use_fewshot=False` volontairement, le UI passe `True`) |

---

## 8. Historique des corrections

| Date | Scope | Description |
|------|-------|-------------|
| 2026-02-18 | Documentation | Corrigé README.md, architecture.md, adapter-format-bulletin.md |
| 2026-02-18 | DRY | Extraction couche service (`src/services/`), refactoring cache.py et routers |
| 2026-02-18 | Bug fix | Corrigé "Genre transmis à l'IA" → "non transmis" dans home.py |
