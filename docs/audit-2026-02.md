# Audit Chiron — Février 2026

## Corrections effectuées

| Date | Scope | Description |
|------|-------|-------------|
| 2026-02-18 | Documentation | Corrigé README.md, architecture.md, adapter-format-bulletin.md |
| 2026-02-18 | DRY | Extraction couche service (`src/services/`), refactoring cache.py (666→290 lignes) et routers |
| 2026-02-18 | Bug fix | Corrigé "Genre transmis à l'IA" → "non transmis" dans home.py |
| 2026-02-18 | YAGNI | Supprimé colonnes OCR inutilisées, `src/api/main.py` et `src/api/config.py` standalone |
| 2026-02-19 | Bug fix | Activé few-shot examples dans les endpoints API (`use_fewshot=True`) |

---

## Reste à faire

### 1. Tests (couverture actuelle : 0%)

#### Priorité 1 — Tests unitaires (fonctions pures)

Aucune dépendance externe, exécution instantanée.

| Fichier | Quoi tester |
|---------|-------------|
| `src/services/shared.py` | `build_llm_metadata()` retourne les 11 clés attendues |
| `src/document/validation.py` | `validate_extraction()` détecte les bulletins invalides (pas de matières, notes hors bornes...) |
| `src/document/anonymizer.py` | `extract_eleve_name()` extrait nom/prénom depuis un texte brut |
| `src/core/models.py` | Validation Pydantic (notes > 20, trimestres invalides...) |

#### Priorité 2 — Pseudonymisation (RGPD critique)

Base DuckDB temporaire en mémoire.

| Fichier | Quoi tester |
|---------|-------------|
| `src/privacy/pseudonymizer.py` | `create_eleve_id()` génère un ID unique et stable |
| | `depseudonymize_text()` restaure les vrais noms |
| | Même élève + même classe → même ID |
| `src/api/routers/exports.py` | `_pseudonymize_extraction()` remplace toutes les variantes du nom |

#### Priorité 3 — Repositories (CRUD base de données)

Base DuckDB `:memory:` avec schéma initialisé.

| Repository | Quoi tester |
|------------|-------------|
| `ClasseRepository` | Créer, lire, lister, supprimer |
| `EleveRepository` | Créer, `exists()`, clé composite `(eleve_id, classe_id, trimestre)` |
| `SyntheseRepository` | Créer, update status, `get_validated()`, `get_pending()` |

#### Priorité 4 — Endpoints API (FastAPI TestClient)

Requêtes HTTP simulées sans serveur.

| Router | Quoi tester |
|--------|-------------|
| `exports.py` | Upload PDF invalide → 400, fichier trop gros → 400 |
| `syntheses.py` | Trimestre = 5 → erreur validation, provider inconnu → erreur |
| `classes.py` | GET classe inexistante → 404 |

#### Priorité 5 — Intégration (pipeline complet)

Flux import PDF → parsing → pseudonymisation → stockage, avec un PDF de test anonymisé.

#### Non testé (volontairement)

- **Sorties LLM** : non déterministes → on mocke le LLM et on teste le pipeline autour
- **UI NiceGUI** : complexe, faible valeur ajoutée pour un outil desktop
- **Tests E2E navigateur** : disproportionné pour le use case

### 2. CI/CD

| Élément | Statut |
|---------|--------|
| GitHub Actions | Aucun — à créer (lint + tests) |
| pytest-cov | Non installé |
| Pre-commit | Présent (ruff format/lint uniquement) |

### 3. Open-source readiness

| Élément | Priorité | Statut |
|---------|----------|--------|
| Tests | CRITIQUE | À faire |
| CI/CD | CRITIQUE | À faire |
| Licence propriétaire | CRITIQUE | À changer |
| CONTRIBUTING.md | HAUTE | À créer |
| CHANGELOG | MOYENNE | À créer |

### 4. DRY résiduel (basse priorité)

- `parse()` boilerplate entre `yaml_template_parser.py` et `pdfplumber_parser.py`
